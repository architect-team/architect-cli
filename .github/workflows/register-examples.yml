name: Register Example Components

on: push

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - uses: actions/checkout@master
      - name: Install jq library
        run: sudo apt-get update && sudo apt-get install jq
      - id: detect
        name: Detect which examples have changes
        run: |
          export ARCHITECT_DIRS=$(find ./examples/*/architect.yml -type f -maxdepth 0 -exec dirname {} \; | uniq)
          echo $ARCHITECT_DIRS
          for dir in $ARCHITECT_DIRS; do echo $dir; done
          for dir in $ARCHITECT_DIRS; do test $(git diff-tree --name-only --no-commit-id -r HEAD "$dir" | wc -c) -ne 0 && echo $dir; done
          export CHANGED_DIRS=$(for dir in $ARCHITECT_DIRS; do test $(git diff-tree --name-only --no-commit-id -r HEAD "$dir" | wc -c) -ne 0 && echo $dir; done)
          echo $CHANGED_DIRS
          echo $(jq -n -c --arg v "$CHANGED_DIRS" '{"component_path": $v | split("\n") }')
          echo "::set-output name=matrix::$(jq -n -c --arg v "$CHANGED_DIRS" '{"component_path": $v | split("\n") }')"
  register-components:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJson(needs.detect-changes.outputs.matrix)}}
    steps:
      - uses: actions/checkout@master
      - name: Register component
        run: echo ${{ matrix.component_path }}
