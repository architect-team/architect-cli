version: '3'
services:
  gateway:
    image: traefik:v2.4.14
    command:
      - '--api.insecure=true'
      - '--pilot.dashboard=false'
      - '--accesslog=true'
      - '--accesslog.filters.statusCodes=400-599'
      - '--entryPoints.web.address=:80'
      - '--providers.docker=true'
      - '--providers.docker.exposedByDefault=false'
      - '--providers.docker.constraints=Label(`traefik.port`,`80`)'
    ports:
      - '80:80'
      - '8080:8080'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
  stateful-component--api-db:
    environment:
      POSTGRES_USER: architect
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: stateful
    ports:
      - '50000:5432'
    external_links:
      - gateway:frontend.arc.localhost
    image: postgres:12
    labels:
      - architect.ref=stateful-component.services.api-db
  stateful-component--stateful-api:
    environment:
      DB_ADDR: postgresql://stateful-component--api-db:5432/stateful
      DB_USER: architect
      DB_PASS: secret
    ports:
      - '50001:8080'
    external_links:
      - gateway:frontend.arc.localhost
    labels:
      - architect.ref=stateful-component.services.stateful-api
    build:
      context: >-
        /home/muesch/Architect/code/architect-cli/examples/stateful-component/backend
  stateful-component--frontend:
    environment:
      API_ADDR: http://stateful-component--stateful-api:8080
    ports:
      - '50002:8081'
    external_links:
      - gateway:frontend.arc.localhost
    labels:
      - architect.ref=stateful-component.services.frontend
      - traefik.enable=true
      - traefik.port=80
      - >-
        traefik.http.routers.stateful-component--frontend-frontend.rule=Host(`frontend.arc.localhost`)
      - >-
        traefik.http.routers.stateful-component--frontend-frontend.service=stateful-component--frontend-frontend-service
      - >-
        traefik.http.services.stateful-component--frontend-frontend-service.loadbalancer.server.port=8081
    build:
      context: >-
        /home/muesch/Architect/code/architect-cli/examples/stateful-component/frontend
volumes: {}
