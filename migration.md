# Architect updates and migration

## Code and terraform updates

### EC2

* EBS volumes encrypted with CMK generated by terraform
  * Includes the root EBS Kubernetes volume created for EKS
  * Includes dynamically-generated volumes in Kubernetes as EBS volumes

### EFS

* ~~The Architect deployment doesn't use EFS volumes~~ Volumes created by ECS platforms and created by ECS deployments need to be encrypted

### S3

* Access logging for S3 enabled and logs will be written to a new bucket specifically for access logging. Enabled for both the registry and credentials buckets
* Encryption in transit to S3 enabled
* Encryption at rest and versioning enabled for all S3 buckets
* Object-level logging for credential and registry buckets with Cloudtrail enabled

### Secrets Manager

* Secrets created by Architect are encrypted with the KMS key created by terraform

### RDS

* Copy tags to snapshot enabled for DB cluster
* RDS cluster replication set to two zones for High Availability
* IAM database authentication enabled for RDS cluster
* RDS encryption at rest enabled and uses CMK created by terraform

## Migration plan

Install the AWS CLI if you haven't already.

1. Clone Architect AWS terraform to a new repo to avoid any confusion. (git clone https://dphs-all-dev:n7_g-ex9r7z_S3DRNYi3@gitlab.com/architect-io/on-prem/aws.git)
2. On the AWS dashboard, take a snapshot of the existing Architect RDS database. If any changes occur on the onprem Architect instance after this step, a new snapshot must be created.
3. Add the ARN of the snapshot as the value of the variable `db_snapshot_arn` in `bootstrap.tfvars` in the new terraform repo. The new RDS cluster will be created from this snapshot.
4. Create new folders called `registry` and `credentials` on the new repo. For each bucket and folder pair, clone the contents of each bucket using a version of the command `aws s3 cp s3://<s3_bucket_name>/ ./<local_folder_name>/ --recursive`.
5. Follow the README included in the repo to create the new version of the Architect infrastructure.
5.5. wait for a while
6. Upload the contents of the local folders `registry` and `credentials` to the newly-created S3 buckets using versions of the command `aws s3 cp ./<local_folder_name>/ s3://<s3_bucket_name>/ --recursive`.
7. Change the DNS records for your provider to use the NS records of the new Route53 zone.
8. Import any Route53 records that exist in the old Route53 zone to the new one using the AWS dashboard. Check the suffixes (domains) of the imported records.
----STOPPED HERE - NEEDED TO UPDATE DNS RECORDS---
9. Tear down the old Architect environment and components on the Architect Cloud and delete the old environment, taking note of the name for the next step.
10. Register the new EKS cluster as a new platform (with the `internal_lb` flag) on the Architect Cloud. Install the platform apps. When prompted to create an environment, use the same name as the environment that was deleted in the last step.
TODO TODO TODO TODO PEERING CONNECTIONS
11. Deploy the Architect components to the new environment on the new platform.
12. Update the Architect config for the onprem deployment with the new `cli_oauth_client_id` from `values.tml.yml`.
13. Ensure that everything works as expected and that you can pick up exactly where you left off on the onprem deployment of the Architect Cloud.
14. Uninstall the platform apps from the old Architect prod eks platform. Not doing so will stall the terraform tear down.
15. Tear down the old Architect Cloud resources.


TODO:
EFS volumes created by deployments to ECS environments
secrets migration from secrets manager to database
let errol re-test things and tear down eventually
no deadline exactly on secrets to database storage
meeting with Errol on the 29th for teardown
