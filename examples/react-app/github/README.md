# Automated infrastructure management and deployments

This folder contains a GitHub workflow and supporting files that will automatically create and manage a Kubernetes cluster on AWS. It will also use Architect to automatically deploy the react demo to the cluster on any merges into the `main` branch.

## Requirements

* An [Architect account](https://cloud.architect.io/login)
* A [GitHub account](https://github.com/signup)
* An access key and secret access key for your AWS IAM user
* An [AWS account](https://portal.aws.amazon.com/billing/signup#/start) with the following permissions
  * AmazonRDSFullAccess
  * AmazonS3FullAccess
  * AmazonVPCFullAccess
  * AutoScalingFullAccess
  * IAMFullAccess
  * AmazonEC2FullAccess
  * CloudWatchLogsFullAccess
  * EKSFullAccess (custom inline policy)
    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
          {
              "Sid": "VisualEditor0",
              "Effect": "Allow",
              "Action": "eks:*",
              "Resource": "*"
          }
      ]
    }
    ```

## Repository setup

Create a new repository. Copy the `backend`, `frontend`, and `terraform` folders and the `architect.yml` file to the base directory of the repository. Create a folder called `.github/workflows` in the new repo and copy `deploy.yml` from the `github` folder to the `.github/workflows` directory. Your directory structure should look like the one below.

```
├── .github
│   └── workflows
│       └── deploy.yml
├── backend
│   └── ...
├── frontend
│   └── ...
├── terraform
│   ├── versions.tf
│   ├── variables.tf
│   ├── main.tf
│   └── outputs.tf
└── architect.yml
```

Some files will need to be updated in order to make sure variables are set correctly. In `architect.yml`, set the name of the component to start with the name of your Architect account such as `my-account/react-app`. In the GitHub workflow, `deploy.yml`, set the `ARCHITECT_ACCOUNT` environment variable to the same.

## Terraform backend setup

Create a new bucket on AWS called `react-app-tfstate`. When terraform runs in the GitHub workflow to create the infrastructure, it will store the state in this S3 bucket.

## GitHub secrets

Be sure to add the following secrets on your GitHub repository's settings page as they're required by the GitHub workflow:

* ARCHITECT_EMAIL
* ARCHITECT_PASSWORD (This will be a personal access token generated by you on the Architect Cloud.)
* AWS_ACCESS_KEY_ID
* AWS_SECRET_ACCESS_KEY
* POSTGRES_DATABASE
* POSTGRES_USER
* POSTGRES_PASSWORD

## Running the workflow

That's it! Create and merge a pull request to the `main` branch of your new repo, and your new infrastructure will be created automatically by terraform with the react-app example component deployed by Architect.
